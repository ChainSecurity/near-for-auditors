
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../storage/">
      
      
        <link rel="next" href="../gas/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.2">
    
    
      
        <title>Cross-contract Calls - NEAR for Advanced Users</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d451bc0e.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cross-contract-calls" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="NEAR for Advanced Users" class="md-header__button md-logo" aria-label="NEAR for Advanced Users" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NEAR for Advanced Users
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cross-contract Calls
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="NEAR for Advanced Users" class="md-nav__button md-logo" aria-label="NEAR for Advanced Users" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    NEAR for Advanced Users
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../execution/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Execution
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cross-contract Calls
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cross-contract Calls
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#external-contract-interfaces" class="md-nav__link">
    External Contract interfaces
  </a>
  
    <nav class="md-nav" aria-label="External Contract interfaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expanding-ext_contractext" class="md-nav__link">
    Expanding #[ext_contract(ext)]
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#promises" class="md-nav__link">
    Promises
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-private-macro" class="md-nav__link">
    The #[private] macro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-in-cross-contract-calls" class="md-nav__link">
    Storage in Cross-contract Calls
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../gas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../issues/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common Issues
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resources
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#external-contract-interfaces" class="md-nav__link">
    External Contract interfaces
  </a>
  
    <nav class="md-nav" aria-label="External Contract interfaces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expanding-ext_contractext" class="md-nav__link">
    Expanding #[ext_contract(ext)]
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#promises" class="md-nav__link">
    Promises
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-private-macro" class="md-nav__link">
    The #[private] macro
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-in-cross-contract-calls" class="md-nav__link">
    Storage in Cross-contract Calls
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cross-contract-calls">Cross-contract Calls</h1>
<p>Let us consider the <a href="https://github.com/near/near-sdk-rs/blob/master/examples/callback-results/src/lib.rs">example</a> of a contract that implements some cross-contract calls. Users should be already familiar with how <a href="../execution/">simple executions</a> take place in the runtime.</p>
<h2 id="external-contract-interfaces">External Contract interfaces</h2>
<p>The first thing we need to observe is the definition of <code>ExtCrossContract</code>. Similarly to Solidity, in order for the smart contract to typecheck, we need to define the interface of the external contracts we wish to interact with. In Rust, this happens with a declaration of a trait such as <code>ExtCrossContract</code>. In this particular case, <code>ExtCrossContract</code> implements four functions, namely <code>a</code> which takes no arguments and returns a Promise, i.e. it makes another cross-contract call; <code>b</code> which takes a <code>bool</code> parameter and returns a <code>String</code>; <code>c</code> which takes and returns a <code>u8</code>; and <code>handle_callback</code> which takes three callback results and returns three booleans.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[ext_contract(ext)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">ExtCrossContract</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Promise</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">b</span><span class="p">(</span><span class="n">fail</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">c</span><span class="p">(</span><span class="n">value</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u8</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">handle_callbacks</span><span class="p">(</span>
<span class="w">        </span><span class="cp">#[callback_result]</span><span class="w"> </span><span class="n">a</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="cp">#[callback_result]</span><span class="w"> </span><span class="n">b</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="cp">#[callback_result]</span><span class="w"> </span><span class="n">c</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="expanding-ext_contractext">Expanding <code>#[ext_contract(ext)]</code></h3>
<p>In order to understand the role this trait declaration plays in the execution we need to see the expanded code with <code>cargo-expand</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">ext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">c</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">__account_id</span>: <span class="nc">AccountId</span><span class="p">,</span>
<span class="w">    </span><span class="n">__balance</span>: <span class="nc">near_sdk</span>::<span class="n">Balance</span><span class="p">,</span>
<span class="w">    </span><span class="n">__gas</span>: <span class="nc">near_sdk</span>::<span class="n">Gas</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">near_sdk</span>::<span class="n">Promise</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[serde(crate = </span><span class="s">&quot;near_sdk::serde&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">Input</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">value</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cp">#[doc(hidden)]</span>
<span class="w">    </span><span class="cp">#[allow(non_upper_case_globals, unused_attributes, unused_qualifications)]</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">..</span><span class="p">.};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">near_sdk</span>::<span class="n">serde_json</span>::<span class="n">to_vec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to serialize the cross contract args using JSON.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">near_sdk</span>::<span class="n">Promise</span>::<span class="n">new</span><span class="p">(</span><span class="n">__account_id</span><span class="p">).</span><span class="n">function_call</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">__balance</span><span class="p">,</span><span class="w"> </span><span class="n">__gas</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div>
<p>The trait turns into a module which is essentially a Promise factory. A Promise is just a <code>FunctionCall</code> action with some arguments. When you pass an argument to <code>c</code>, it needs to be serialized, so it is important for the factory to know that it expects an argument. It is important to note, however, that arguments annotated with <code>#[callback_result]</code> are essentially ignored since they do not need be passed. This means that we could omit them. Later we will see how the promise results are handled by the runtime.</p>
<p>The expanded version of <code>ExtCrossContract</code> gives us a hint about the API for a cross-contract call. Except for the actual arguments to the call function, e.g. <code>value</code> in the case of <code>c</code>, we need to specify the <code>__account_id</code>, which is the id of the account to receive the call; the <code>__balance</code> which is the number of NEAR tokens we pass/transfer in the call; and the <code>__gas</code> which is the amount of gas to provide for this call to execute.</p>
<p>If we inspect <code>a</code> we will see the following:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Promise</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ext</span>::<span class="n">c</span><span class="p">(</span>
<span class="w">        </span><span class="n">A_VALUE</span><span class="p">,</span>
<span class="w">        </span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="n">env</span>::<span class="n">prepaid_gas</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Indeed, in order to make a cross contract call we call a function from <code>ext</code> module and we pass the arguments as discussed.</p>
<h2 id="promises">Promises</h2>
<p>Cross-contract calls are implemented with <a href="https://nomicon.io/RuntimeSpec/Components/BindingsSpec/PromisesAPI.html">Promises</a>. Promises are just action receipts to another or the same shard. A function call that makes a cross-contract call <strong>must</strong> return a <code>Promise</code>. However, an action receipt might need to wait some time before it executes. The Promise API is used in that case. When the promise is returned to the runtime after a function call, the runtime will create the corresponding action receipts and send them to the appropriate shards. Then, when the action receipt has no data receipts pending, it will execute. For example, consider the receipts which are created here. Four action receipts will be created one for each promise namely the calls <code>ext::a</code>, <code>ext::b</code>, <code>ext::c</code>, <code>ext::handle_callback</code>. The first three receipts have no dependencies. The last, however, does. This means that 3 data receipts will be created. Moreover, note that the first call (<code>a</code>) will eventually make another cross-contract call.</p>
<div class="highlight"><pre><span></span><code><span class="n">ext</span>::<span class="n">a</span><span class="p">(</span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">ext</span>::<span class="n">b</span><span class="p">(</span><span class="n">fail_b</span><span class="p">,</span><span class="w"> </span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">ext</span>::<span class="n">c</span><span class="p">(</span><span class="n">c_value</span><span class="p">,</span><span class="w"> </span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">then</span><span class="p">(</span><span class="n">ext</span>::<span class="n">handle_callbacks</span><span class="p">(</span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">))</span>
</code></pre></div>
<p>All of the above are summarized in the following diagram:</p>
<p><a href="../img/cross_contract_merge.svg"> <img alt="Sharded" src="../img/cross_contract_merge.svg" /> </a></p>
<p>In Figure I. we show how the calls would be executed to arbitrary contracts. However, in this particular case, all calls are made to the contract itself; thus, they will be executed in the same shard as shown in Figure II. (click on the figure to zoom)</p>
<p>As soon as there are no pending data receipts, <code>handle_callback</code> will be executed.
<code>handle_callbacks</code> has the following definition:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle_callbacks</span><span class="p">(</span>
<span class="w">    </span><span class="cp">#[callback_unwrap]</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="cp">#[callback_result]</span><span class="w"> </span><span class="n">b</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="cp">#[callback_result]</span><span class="w"> </span><span class="n">c</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">A_VALUE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Promise returned incorrect value&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">require</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Some string&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">is_err</span><span class="p">(),</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">is_err</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
<p>It takes the results of three promises as arguments. This means that it will try to read these results from the execution environment (<code>env</code>). As soon as all the dependencies are satisfied, the following method will be executed by the runtime.</p>
<p>Let us inspect part of the expanded version of the definition of <code>handle_callbacks</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle_callbacks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">setup_panic_hook</span><span class="p">();</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u8</span> <span class="o">=</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">serde_json</span>::<span class="n">from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to deserialize callback using JSON&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">promise_result</span><span class="p">(</span><span class="mi">1</span><span class="k">u64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">PromiseResult</span>::<span class="n">Successful</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">near_sdk</span>::<span class="n">serde_json</span>::<span class="n">from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to deserialize callback using JSON&quot;</span><span class="p">)),</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">PromiseResult</span>::<span class="n">NotReady</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">near_sdk</span>::<span class="n">PromiseError</span>::<span class="n">NotReady</span><span class="p">),</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">PromiseResult</span>::<span class="n">Failed</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">near_sdk</span>::<span class="n">PromiseError</span>::<span class="n">Failed</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">PromiseError</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">promise_result</span><span class="p">(</span><span class="mi">2</span><span class="k">u64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">PromiseResult</span>::<span class="n">Successful</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">near_sdk</span>::<span class="n">serde_json</span>::<span class="n">from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to deserialize callback using JSON&quot;</span><span class="p">)),</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">PromiseResult</span>::<span class="n">NotReady</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">near_sdk</span>::<span class="n">PromiseError</span>::<span class="n">NotReady</span><span class="p">),</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">PromiseResult</span>::<span class="n">Failed</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">near_sdk</span>::<span class="n">PromiseError</span>::<span class="n">Failed</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Callback</span>::<span class="n">handle_callbacks</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">near_sdk</span>::<span class="n">serde_json</span>::<span class="n">to_vec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to serialize the return value using JSON.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">value_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>What we see here is that the call will try to read the first three promise results from the environment, parse them and then execute the logic inside <code>handle_callbacks</code>. This also explains why we don't need to pass any arguments when we create the call to <code>handle_callbacks</code>. </p>
<p>It is important to note that the runtime is not aware of the promise dependencies of the call during the execution of the call. In other words, the action receipt would wait for the three calls to execute even if it would make use of only two of them. 
Conversely, an action receipt waiting for 2 data receipts could execute even if the method it executes takes three promise arguments. Whether the correct dependencies are satisfied is the responsibility of the developer. Moreover we need to emphasize the "random" nature of the execution in a concurrent environment. There are no guarantees about the order of execution of cross-contract calls. Developers should explicitly define the order of execution if required, using the Promise API. For example, there are no guarantees provided by the specification of the protocol that the following cross-contract calls(<code>a()</code>, <code>b(fail_b)</code>, <code>c(c_value)</code>) aiming the same shard will executed in that order as given in the snippet below:</p>
<div class="highlight"><pre><span></span><code><span class="n">ext</span>::<span class="n">a</span><span class="p">(</span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">ext</span>::<span class="n">b</span><span class="p">(</span><span class="n">fail_b</span><span class="p">,</span><span class="w"> </span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">ext</span>::<span class="n">c</span><span class="p">(</span><span class="n">c_value</span><span class="p">,</span><span class="w"> </span><span class="n">env</span>::<span class="n">current_account_id</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gas_per_promise</span><span class="p">))</span>
</code></pre></div>
<p>Another important point is the return value of an external call. In a trustless environment, an external call might not fully satisfy the assumed interface. In other words, a call to an external contract might return a different type than expected. This would lead the callback to fail. For example, consider a cross contract call to a contract which satisfies the interface of ExtCrossContract except for the return value of <code>b</code> for which it instead returns a String. When the callback tries to process the result of the Promise, it will fail.</p>
<h2 id="the-private-macro">The <code>#[private]</code> macro</h2>
<p>The <code>#[private]</code> macro specifies that a function can only be externally called by the contract itself. In its expanded version, it looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">current_account_id</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">predecessor_account_id</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">near_sdk</span>::<span class="n">env</span>::<span class="n">panic_str</span><span class="p">(</span><span class="s">&quot;Method handle_callbacks is private&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>This allows the restriction of access to callback functions to prevent external contracts from injecting data into a function that is expected to be called by the contract itself. Note that a "private" function must still be defined as a <code>pub fn</code>, which allows it to be called externally!</p>
<h2 id="storage-in-cross-contract-calls">Storage in Cross-contract Calls</h2>
<p>As we have discussed, in contrast to Ethereum where transactions are executed atomically, in NEAR only Action Receipts are executed atomically. As we have showed in this tutorial, cross-contract calls create new Action Receipts.</p>
<p>Let us consider the case where any of the calls of the <code>call_all</code> method failed. The failure of the cross-contract call, e.g., <code>a</code>, would lead to reverting the storage modification performed by <code>a</code> <strong>only</strong>. However, the modification caused by <code>call_all</code> would <strong>not</strong> be reverted. Moreover, <code>handle_callback</code> is indifferent of whether any of the external calls it awaits failed. As soon as all the external calls are executed, <code>handle_callback</code> can also execute. If we want to revert the changes of <code>call_all</code>, we should do it manually in <code>handle_callback</code>. At this point we want to draw the reader's attention to two important points:</p>
<ol>
<li>Each contract is responsible for reverting its own state. Thus, failures of cross-contract calls should be handled manually.</li>
<li>To revert the storage manually, the action needs to have enough gas. This should also be guaranteed by the implementation.</li>
</ol>
<p>The NEAR runtime does not prevent a second call to the same contract method from executing while the first one waits for its dependencies. This means that any modification of the first method call will be visible in the second one. For example, the following scenario is possible:</p>
<ol>
<li>User <code>A</code> makes a call to method <code>a</code> of contract <code>C</code> which modifies the state of the contract. <code>a</code> makes a cross-contract call and uses a callback <code>ca</code> to handle the result of the cross-contract call.</li>
<li><code>ca</code> awaits the completion of the cross-contract call</li>
<li>User <code>B</code> makes a call to method <code>a</code> of <code>C</code>. This execution will use the updated state from 1.</li>
</ol>
<p>The Figure below illustrates the example:</p>
<p><a href="../img/concurrency.svg"> <img alt="Sharded" src="../img/concurrency.svg" /> </a></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.a264c092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.726fbb30.min.js"></script>
      
    
  </body>
</html>